---
layout:     post
title:      "运维笔记"
subtitle:   "Linux用户和权限管理"
date:       2025-9-16
author:     "杨奕城"
tags:
    - 运维
    - Linux
    - 用户
    - 权限
---

# Linux安全模型

- 认证
- 授权
- 审计

Linux中用户登录成功后，系统自动分配令牌token。包括用户标识和组成员等信息

## 用户

Linux是多用户系统

每个用户互相隔离

每个用户通过id唯一标识

### id

- 管理员root 0
- 普通1~60000自动分配
- 系统用户1~999（centos7后）系统进程需要用户身份运行
- 登录用户1000+

### 组

- 管理员组 0
- 系统组1~999（centos7后）系统进程需要用户身份运行
- 普通组1000+

### 用户和组的关系

- 一个用户至少一个组
- 一个组可以没有用户也可以有多个用户
- 主要组和用户名同名，用户必须属于且只有一个主组
- 一个用户可以属于0个或多个附加组
- 使用组可以对用户实现批量管理

## 安全上下文

程序 可执行的二进制文件

进程 运行中的程序

- 进程能不能运行取决于用户对程序有没有可执行权限
- 进程能访问的资源权限与取决于运行者身份

# 用户和组的配置文件

- /etc/passwd 用户及其属性，密码在此用占位符表示
- /etc/shadow 用户密码及其相关属性
- /etc/group 组及其属性
- /etc/gshadow 组密码及其相关属性

## passwd

![screen-capture](/img/in-post/Linux用户和权限管理/afe7163d6fab81fc2ad59194b4fae1a1.png)

## shadow

![screen-capture](/img/in-post/Linux用户和权限管理/71359fdf10e056ba5561864a90b3bbdc.png)

## group

![screen-capture](/img/in-post/Linux用户和权限管理/1dcfdde73470e92d87e1267245ad4564.png)

## gshadow

![screen-capture](/img/in-post/Linux用户和权限管理/da7ee8bb81ec702a818dccf9ef4d6b27.png)

## 配置文件操作

跟用户和权限有关的文件具有敏感性，系统提供了专用的工具来修改这几个文件

## vipw & vigr

![screen-capture](/img/in-post/Linux用户和权限管理/2f8427c865d2214329c73da02f8ec7d8.png)

## pwck & grpck

![screen-capture](/img/in-post/Linux用户和权限管理/e7012d31386af053605ba375dc05b393.png)

![screen-capture](/img/in-post/Linux用户和权限管理/b2b1a4c5b8ffe74e208abdd221c7da80.png)

## getent

```
getent passwd|shadow|group|gshadow uname
```

# 用户和组管理命令

## 用户创建

```
useradd
  -u 指定uid
  -g 指定gid
  -c 指定注释字段
  -d 指定家目录
  -s 指定shell
  -m 创建家目录
  -M 不创建家目录
  -D 查看默认配置
```

Ubuntu添加后用户id和组id相同，但不会创建home目录

Rocky会创建目录

先创建组再创建用户，可以确保组id符合要求

![screen-capture](/img/in-post/Linux用户和权限管理/e14c3fb812f6d6186a41fcc40c5a12c9.png)

```
newusers file 批量创建用户
chpasswd < file 批量修改用户密码
```

## 用户修改

```
usermod
  -u 指定uid
  -g 指定gid
  -c 指定注释字段
  -d 指定家目录
  -s 指定shell
  -l 指定名称
  -L 锁定
  -U 解锁
```

修改只修改用户，不修改组

### 用户锁定

```
usermod -L
usermod -U
```

用户密码无法通过usermod -U去除，可以通过修改/etc/shadow将密码栏置空创建空密码账户

## 用户删除

```
userdel
  -f 强制删除
  -r 删除家目录和邮件目录
```

用户登陆时无法删除 可使用-f强制删除

## 查看id

```
id
  -a 详细信息
  -u uid
  -g gid
  -G 所有gid，包含主组和附加组
  -n 显示用户名或组名，要组合使用 -nu|-ng|-nG
```

## 切换用户或以其它用户身份执行命令

让有权限用户执行

让当前终端临时切换用户

```
su 非登录式切换
su - 登录式切换
```

非登录式切换不会读取目标用户配置文件，不改变工作目录

登录式切换相当于重新登陆

除root可以不输密码切换用户，普通用户都需要输入目标密码切换

切换至新用户时不要用su切换回旧用户，否则会产生很多bash子进程，需要使用exit返回

无法切换到nologin或者false的用户

## 设置密码

```
password
```

root无需输入当前密码可修改

普通用户需验证当前密码

![screen-capture](/img/in-post/Linux用户和权限管理/2aa32f692238c17f214bf739e43ad7d6.png)

## 设置密码策略

```
chage
```

![screen-capture](/img/in-post/Linux用户和权限管理/f1ce7d99cdb9c10cf5e098e69dff2d81.png)

![screen-capture](/img/in-post/Linux用户和权限管理/8abc5d350c71b0cd03512a9131b9d8c4.png)

<br/>

## 创建组

```
groupadd
  -g gid
  -r 创建系统组
  -p 明文密码
```

## 修改组

```
groupmod
  -g gid
  -n 组名
  -p 明文密码
```

## 删除组

```
groupdel
  -f 强制删除
```

不能删除用户的主组

删用户时会自动删除该用户同id的主组

## 更改组成员和密码

```
gpasswd
  -a 添加用户
  -d 移出用户
```

## 更改和查看组成员

```
groupmems
  -a 添加用户
  -d 移出用户
  -l 组成员列表
groups 查看用户所属组列表
```

# 文件权限管理

## Linux文件体系结构

对文件来说，用户分为属主，属组，其他

对用户来说对文件的权限分为读、写、执行（rwx）

权限分为9列，属主、属组、其他各占3列

## 文件所有者和属组属性操作

```
chown
```

修改属主或属组

按照属主->属组->其他顺序匹配 匹配一个后停止

若是属主，则没有属组和其他权限

```
chown user filename
chown user. filename
chown .group filename
chown user.group filename
```

修改所属id时id对应用户和组可以不存在，修改名称时必须存在

```
chgrp
```

只能修改组

## 文件权限

```
chmod 表达式 filename
```

- 角色 u g o a
- 赋值 + - =
- 权限 r w x

![screen-capture](/img/in-post/Linux用户和权限管理/1a73fad63373b893e5735591771de4e0.png)

r和w权限对root无效，root对所有文件都可读可写

只要属主、属组、其它有任一有执行权限root就可以执行

### 权限八进制表示

rwx对应421

例如

- 664->rw-rw-r--
- 777->rwxrwxrwx

## 新建文件或目录默认权限

root新建目录权限755

普通用户新建目录权限775

root新建普通文件权限644

普通用户新建普通文件默认权限664

666-umask决定新建普通文件权限，若存在执行则\+1

777-umask决定新建目录权限

![screen-capture](/img/in-post/Linux用户和权限管理/44559446afd4022fef8d0806dd031c50.png)

umask root默认值022 普通用户002

![screen-capture](/img/in-post/Linux用户和权限管理/740dfe04c57da6c8acc646f53eb997c5.png)

## Linux上的特殊权限

- SUID 作用于可执行文件，用户继承属主权限
- SGID 作用于可执行文件，用户继承属组权限。作用于目录，目录下新建的文件和目录的属组都继承该目录属组
- Sticky 作用于目录，目录下文件只能由所有者自己删除

### SUID

```
chmod g+s FILE
chmod 2xxx FILE
chmod g-s FILE
```

例如：普通用户执行passwd时可以以root身份修改shadow

### SGID

```
chmod g+s DIR
chmod 2xxx DIR
chmod g-s DIR
```

目录有SGID权限后，目录下新建的文件和目录的属组都继承该目录属组

### Sticky

```
chmod o+t DIR
chmod 1xxx DIR
chmod o-t DIR
```

对目录有写权限的用户可以删除该目录下的任何文件或文件夹，无论有无目录下文件的权限

设置后只有文件所有者和root可以删除目录下的文件

只能设置在目录，设置在文件上无效

### 特殊权限数字法

SUID占据属主执行权限位

- s代表有执行权限
- S代表没有执行权限

SGID占据属组执行权限位

- s代表有执行权限
- S代表没有执行权限

Sticky占据其它执行权限位

- t代表有执行权限
- T代表没有执行权限

### 设定文件特殊属性

```
chattr 修改特殊属性
```

赋值 + - =
- i防止删除或修改
- a用于日志
- s彻底删除，使用0填充源数据块
- u防止误删除，不会被覆盖

```
lsattr 查看特殊属性
```

# 访问控制列表ACL

## ACL权限功能

所有者，自定义用户，所属组，自定义组，其他、

从前往后匹配，匹配到就停止

```
setfacl
  -m 修改
    u:name:rwx
    g:name:rwx
  -x 删除
    u:name
    g:name
  -b 删除全部
```

```
getfacl 查看ACL权限列表
```

从文件复制ACL

```
getfacl f1 f2
```

mask只影响所有者和other之外的人和组的权限

mask和用户权限与运算后变成有限的权限

<br/>

对于脚本来说必须要有rx权限才能运行

